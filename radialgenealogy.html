<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Radial Genealogy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  overflow: hidden;
  font-family: Arial, sans-serif;
  background: #f0f0f0;
}

#layout {
  display: flex;
  height: 100vh;
}

#canvas {
  flex: 1;
  background: #fafafa;
}

#sidebar {
  width: 170px;
  background: #222;
  color: white;
  padding: 8px;
  overflow-y: auto;
}

button {
  width: 100%;
  margin: 6px 0;
  padding: 8px;
  cursor: pointer;
}

.tab {
  padding: 6px;
  background: #444;
  margin: 4px 0;
  cursor: pointer;
}

.tab.active {
  background: #666;
}

text {
  pointer-events: none;
  user-select: none;
}
</style>
</head>

<body>
<div id="layout">
  <svg id="canvas"></svg>

  <div id="sidebar">
    <button onclick="newTree()">âž• New</button>
    <button onclick="saveTree()">ðŸ’¾ Save</button>
    <button onclick="loadTree()">ðŸ“‚ Load</button>
    <hr>
    <div id="tabs"></div>
  </div>
</div>

<script>
const svg = document.getElementById("canvas");
const NS = "http://www.w3.org/2000/svg";
const view = document.createElementNS(NS,"g");
svg.appendChild(view);

let trees=[], active=0;
let scale=1, tx=0, ty=0;

function rootNode() {
  return { name:"Double-click to rename", children:[], depth:0, hue:0 };
}

newTree();

/* ---------- TABS ---------- */

function newTree(){
  trees.push({name:"Untitled",root:rootNode()});
  active=trees.length-1;
  resetView();
  updateTabs();
  draw();
}

function updateTabs(){
  const t=document.getElementById("tabs");
  t.innerHTML="";
  trees.forEach((tr,i)=>{
    const d=document.createElement("div");
    d.className="tab"+(i===active?" active":"");
    d.textContent=tr.name;

    d.onclick=()=>{active=i;draw();updateTabs();};

    d.ondblclick=()=>{
      const n=prompt("Rename tree (blank deletes):",tr.name);
      if(n===null) return;
      if(n===""){trees.splice(i,1);active=Math.max(0,active-1);}
      else tr.name=n;
      updateTabs();draw();
    };

    t.appendChild(d);
  });
}

/* ---------- DRAW ---------- */

function draw(){
  view.innerHTML="";
  const cx=svg.clientWidth/2;
  const cy=svg.clientHeight/2;
  drawNode(trees[active].root,cx,cy,0,Math.PI*2,60);
}

function drawNode(node,cx,cy,a1,a2,r){
  if(node.depth===0) drawCircle(cx,cy,r,node);
  if(!node.children.length) return;

  const slice=(a2-a1)/node.children.length;
  const r2=r+90;

  node.children.forEach((ch,i)=>{
    const s=a1+i*slice, e=s+slice;
    drawWedge(cx,cy,r,r2,s,e,ch);
    drawNode(ch,cx,cy,s,e,r2);
  });
}

function drawCircle(x,y,r,node){
  const c=document.createElementNS(NS,"circle");
  c.setAttribute("cx",x);
  c.setAttribute("cy",y);
  c.setAttribute("r",r);
  c.setAttribute("fill","#ddd");
  bindEvents(c,node);
  view.appendChild(c);
  drawLabel(node.name,x,y,r*0.7,node.depth);
}

function drawWedge(cx,cy,r1,r2,a1,a2,node){
  const p=(r,a)=>[cx+Math.cos(a)*r,cy+Math.sin(a)*r];
  const [x1,y1]=p(r1,a1),[x2,y2]=p(r1,a2),
        [x3,y3]=p(r2,a2),[x4,y4]=p(r2,a1);

  const path=document.createElementNS(NS,"path");
  path.setAttribute("d",
    `M${x1} ${y1} A${r1} ${r1} 0 0 1 ${x2} ${y2}
     L${x3} ${y3} A${r2} ${r2} 0 0 0 ${x4} ${y4} Z`
  );

  const light=70 - node.depth*6;
  path.setAttribute("fill",`hsl(${node.hue},70%,${light}%)`);

  bindEvents(path,node);
  view.appendChild(path);

  const ang=(a1+a2)/2;
  const offset=(node.depth>1)?10:0;

  drawLabel(
    node.name,
    cx+Math.cos(ang)*(r1+(r2-r1)/2+offset),
    cy+Math.sin(ang)*(r1+(r2-r1)/2+offset),
    (r2-r1)*0.55,
    node.depth
  );
}

/* ---------- TEXT FIT (STRONGER) ---------- */

function drawLabel(text,x,y,max,depth){
  const t=document.createElementNS(NS,"text");
  t.setAttribute("x",x);
  t.setAttribute("y",y);
  t.setAttribute("text-anchor","middle");
  t.setAttribute("dominant-baseline","middle");
  t.textContent=text;

  let size=Math.min(14, max);
  const limit=max*(depth>=2?0.75:1);

  while(size>2){
    t.setAttribute("font-size",size);
    view.appendChild(t);
    if(t.getComputedTextLength()<=limit) break;
    view.removeChild(t);
    size--;
  }

  view.appendChild(t);
}

/* ---------- INTERACTION ---------- */

function bindEvents(el,node){
  let timer;
  el.onclick=e=>{
    e.stopPropagation();
    timer=setTimeout(()=>addChild(node),220);
  };
  el.ondblclick=e=>{
    e.stopPropagation();
    clearTimeout(timer);
    rename(node);
  };
}

function addChild(node){
  const name=prompt("Child name:");
  if(!name) return;

  const hue=node.depth===0
    ? (node.children.length*137)%360
    : node.hue;

  node.children.push({name,children:[],depth:node.depth+1,hue});
  draw();
}

function rename(node){
  const name=prompt("Rename:",node.name);
  if(name) node.name=name;
  draw();
}

/* ---------- ZOOM (FIXED) ---------- */

svg.addEventListener("wheel",e=>{
  e.preventDefault();
  const pt=svg.createSVGPoint();
  pt.x=e.clientX; pt.y=e.clientY;
  const before=pt.matrixTransform(view.getCTM().inverse());

  const z=e.deltaY<0?1.1:0.9;
  scale*=z;

  tx += before.x*(1-z);
  ty += before.y*(1-z);

  updateTransform();
});

/* ---------- PAN ---------- */

svg.addEventListener("mousedown",e=>{
  if(e.button!==1) return;
  let x=e.clientX,y=e.clientY;
  window.onmousemove=ev=>{
    tx+=ev.clientX-x;
    ty+=ev.clientY-y;
    x=ev.clientX; y=ev.clientY;
    updateTransform();
  };
  window.onmouseup=()=>window.onmousemove=null;
});

function updateTransform(){
  view.setAttribute("transform",`translate(${tx},${ty}) scale(${scale})`);
}

function resetView(){
  scale=1; tx=0; ty=0; updateTransform();
}

/* ---------- SAVE / LOAD ---------- */

function saveTree(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(
    new Blob([JSON.stringify(trees[active],null,2)],{type:"application/json"})
  );
  a.download="genealogy.json";
  a.click();
}

function loadTree(){
  const i=document.createElement("input");
  i.type="file";
  i.accept=".json";
  i.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{
      trees.push(JSON.parse(r.result));
      active=trees.length-1;
      resetView();
      updateTabs();
      draw();
    };
    r.readAsText(e.target.files[0]);
  };
  i.click();
}

/* ---------- SCREENSHOT EXPORT ---------- */

function exportScreenshot(){
  const rect=svg.getBoundingClientRect();
  const canvas=document.createElement("canvas");
  const scale=2;
  canvas.width=rect.width*scale;
  canvas.height=rect.height*scale;
  const ctx=canvas.getContext("2d");

  ctx.scale(scale,scale);
  ctx.fillStyle="white";
  ctx.fillRect(0,0,rect.width,rect.height);

  const xml=new XMLSerializer().serializeToString(svg);
  const img=new Image();
  img.onload=()=>{
    ctx.drawImage(img,0,0,rect.width,rect.height);
    const a=document.createElement("a");
    a.href=canvas.toDataURL("image/png");
    a.download="genealogy.png";
    a.click();
  };
  img.src="data:image/svg+xml;base64,"+
    btoa(unescape(encodeURIComponent(xml)));
}
</script>
</body>
</html>
